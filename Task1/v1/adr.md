### **Название задачи:**

Система мониторинга и управления животноводческими фермами

### **Автор:**

Хафизуллин Бари Анварович

### **Дата:**

10.08.2025

---

### **Функциональные требования**

| № | Действующие лица или системы           | Use Case                              | Описание                                                                                               |
|:-:|:---------------------------------------|:--------------------------------------|:-------------------------------------------------------------------------------------------------------|
| 1 | Оператор / Зоотехник                   | Получение оповещений                  | Система фиксирует признаки драк, беспокойства, задавливания поросят и отправляет уведомление оператору |
| 2 | Агент фермы                            | Офлайн-работа и локальные уведомления | При отсутствии интернета агент продолжает мониторинг и уведомляет дежурного на месте                   |
| 3 | Оператор / Агент                       | Управление кормушками и поилками      | Отправка команд на оборудование разных производителей                                                  |
| 4 | Видеоаналитика (ML модель)             | Оценка состояния животных             | Детекция болезни, гибели, стресса по внешнему виду и поведению                                         |
| 5 | Агент фермы                            | Пересчёт поголовья                    | Автоматическое определение количества животных по видеопотоку                                          |
| 6 | Система                                | Учёт запасов корма и прогноз расхода  | Сбор данных и прогнозирование потребления                                                              |
| 7 | Центральный сервер                     | Интеграция с ERP/BI                   | Передача базовых и кастомных метрик                                                                    |
| 8 | Система                                | Поддержка камер разных производителей | Работа с RTSP/ONVIF, дневным и ночным режимом                                                          |
| 9 | Пользователь мобильного/веб-приложения | Просмотр метрик и видео               | Доступ к API для получения аналитики и управления                                                      |

---

### **Нефункциональные требования**

| № | Требование                                                                  |
|:-:|:----------------------------------------------------------------------------|
| 1 | Доступность не ниже 99,95%                                                  |
| 2 | Время от фиксации события видеоаналитикой до оповещения ≤ 5 секунд          |
| 3 | Реакция видеоаналитики в реальном времени (миллисекунды)                    |
| 4 | Возможность расширения без изменения существующего функционала              |
| 5 | Работа в условиях нестабильного WiFi и наличие альтернативных каналов связи |
| 6 | Синхронизация между агентами и центральным сервером с задержкой ≤ 10 минут  |

---

### **Решение**

**Контекстная диаграмма (C4 Level 1)**

```plantuml
@startuml
' C4-PlantUML (Context)
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml
' Доп. стили
LAYOUT_WITH_LEGEND()
SHOW_PERSON_OUTLINE()

title C4 Context — Платформа мониторинга и управления животноводческими фермами

' Люди
Person(op, "Оператор / Зоотехник", "Следит за событиями, подтверждает инциденты, управляет оборудованием.")
Person(oncall, "Дежурный сотрудник на ферме", "Получает локальные уведомления при отсутствии интернета.")
Person(mobileUser, "Пользователь мобильного/веб-приложения", "Просмотр метрик, видео и уведомлений.")

' Внешние системы
System_Ext(auth, "Провайдер аутентификации (OIDC/SAML)", "Современная аутентификация и авторизация, роли.")
System_Ext(msgGw, "Шлюз уведомлений", "SMS/Push/Email для оповещений.")
System_Ext(erp, "ERP/Учёт запасов", "Принимает базовые и пользовательские метрики, статусы запасов.")
System_Ext(bi, "BI/Monitoring", "Забирает метрики и события через API.")
System_Ext(mlPartner, "Партнёрская ML-модель", "Готовая модель видеоналитики.")
System_Ext(feeders, "Кормушки/поилки разных производителей", "Управление дозированием корма/воды.")
System_Ext(waterFilt, "Система фильтрации воды", "Телеметрия и статусы.")
System_Ext(cameras, "IP-камеры (разных производителей)", "RTSP/ONVIF, дневной/ночной режим.")
System_Ext(altNet, "Альтернативные каналы связи", "LTE/5G, LoRa/радиоканал для деградационного режима.")

' Наша система (двухзвенная архитектура)
System_Boundary(prod, "Платформа мониторинга и управления (наша система)") {
  System(core, "Центральный сервер (Cloud/DC)", "Агрегация, аналитика, API, управление, федерация агентов.")
  System(agent, "Агент фермы (Edge)", "Реальное время, офлайн-работа, управление оборудованием, локальные уведомления.")
}

' Связи пользователей
Rel(op, core, "Работа через веб-интерфейс / API")
Rel(mobileUser, core, "Мобильное/веб-приложение (API)")
Rel(oncall, agent, "Локальные оповещения", "SMS/Push/звонок")

' Связи с внешними системами
Rel(core, auth, "SSO / OIDC / SAML", "OAuth2/OIDC/SAML")
Rel(core, msgGw, "Отправка уведомлений", "API")
Rel(core, erp, "Публикация метрик/событий", "HTTPS/Webhook")
Rel(core, bi, "Экспорт метрик", "Pull/Push (Prometheus/OpenMetrics)")
Rel(core, mlPartner, "Получение/обновление модели", "Artifact/Registry")
Rel(agent, feeders, "Команды управления", "Вендорские протоколы/API")
Rel(agent, waterFilt, "Телеметрия и статусы", "Modbus/OPC-UA/HTTP")
Rel(agent, cameras, "Видеопотоки для аналитики", "RTSP/ONVIF")
Rel(agent, altNet, "Резервная связь", "При деградации Wi-Fi")

' Взаимодействие центрального сервера и агентов
Rel(core, agent, "Синхронизация конфигурации, метрик и событий (допустима задержка ≤10 мин)", "MQTT/HTTPS/WebSocket")
Rel(agent, core, "Отправка инцидентов, телеметрии, видеоснимков/фич", "С буферизацией офлайн")

' Нотации по требованиям
UpdateElementStyle(core, $fontColor="white", $bgColor="#1168bd")
UpdateElementStyle(agent, $fontColor="white", $bgColor="#438dd5")

' Ключевые требования (как заметки)
AddBoundaryTag(prod, "НФТ", "Нефункциональные требования")

@enduml
```

**Детали архитектуры**

- Двухзвенная архитектура: центральный сервер (Cloud/DC) и агенты на фермах (Edge).
- Агенты обеспечивают локальную аналитику и управление оборудованием, работают автономно при отсутствии связи.
- Видеопотоки обрабатываются нейросетевой моделью, предоставленной партнёрами.
- Синхронизация данных с центральным сервером допускает задержку до 10 минут.
- Поддержка оборудования разных производителей через модульную интеграцию.

---

### **Альтернативы**

- Хранение и обработка видео только в облаке (отказались из-за задержек и зависимости от связи).
- Использование единого типа камер (отказались, так как фермы уже имеют разнородное оборудование).
- Полный отказ от офлайн-режима (отказались из-за нестабильного WiFi и рисков).

---

### **Название задачи:**

Платформа мониторинга состояния животных на фермах (MVP)

### **Автор:**

Хафизуллин Бари Анварович

### **Дата:**

10.08.2025

---

### **Статус**

Альтернатива (Cloud‑first)

### **Проблема**

На животноводческих фермах требуется автоматический мониторинг здоровья и поведения животных, контроль инфраструктуры (кормление, поение,
фильтрация воды), оперативное обнаружение нештатных ситуаций и оповещение персонала. Система должна стабильно работать при нестабильной
связи, поддерживать оборудование разных производителей и предоставлять метрики/интеграции во внешние системы.

---

### **Функциональные требования**

Опишите здесь верхнеуровневые Use Cases. Их нужно оформить в виде таблицы с пошаговым описанием.

| **№** | **Действующие лица или системы**       | **Use Case**                              | **Описание**                                                                                   |
|:-----:|:---------------------------------------|:------------------------------------------|:-----------------------------------------------------------------------------------------------|
|   1   | Система видеоаналитики ← Видеокамеры   | Обнаружение беспокойства/драк             | Поток с камер анализируется; при детекции тревоги формируется событие, запускается оповещение. |
|   2   | Система видеоаналитики ← Видеокамеры   | Обнаружение задавливания поросят          | Модель детектирует характерные позы/скопления; генерирует критическое событие.                 |
|   3   | Оператор → Платформа → Кормушки/поилки | Управление кормлением/поением             | Оператор задаёт режимы; агенты отправляют команды на контроллеры разных производителей.        |
|   4   | Система видеоаналитики                 | Оценка состояния животных                 | Классификация: болезнь, гибель, беспокойство и т.п.; формирование статусов и алертов.          |
|   5   | Агенты → Система фильтрации воды       | Мониторинг фильтрации                     | Сбор телеметрии, контроль аварий, триггер оповещений.                                          |
|   6   | Платформа                              | Пересчёт поголовья                        | Подсчёт особей по видеопотокам/датчикам; сверка с учётными данными.                            |
|   7   | Платформа                              | Учёт запасов и прогноз расхода корма/воды | Интеграция с данными склада и фактическим потреблением; прогнозирование.                       |
|   8   | Платформа                              | Поддержка множества камер                 | Приём потоков от камер разных производителей; масштабирование под реальное время.              |
|   9   | Центральный сервер ↔ Агенты            | Синхронизация данных                      | Агенты работают автономно; синхронизация с центром допускает задержку до 10 минут.             |
|  10   | Платформа → Внешние системы            | Экспорт метрик                            | Предоставление базовых метрик и возможность добавления пользовательских.                       |
|  11   | Платформа → Дежурный сотрудник         | Локальные уведомления без интернета       | При потере связи агент уведомляет дежурного локально; после восстановления — синхронизация.    |
|  12   | Пользователи → Платформа (IdP)         | Роли, аутентификация и авторизация        | Современные механизмы (SSO, RBAC); разграничение доступа.                                      |
|  13   | Мобильное/веб-приложение → API         | Доступ к данным и управлению              | Публичный API для клиентов (web/mobile).                                                       |

---

### **Нефункциональные требования**

Опишите здесь нефункциональные требования и архитектурно значимые требования.

| **№** | **Требование**                                                                                         |
|:-----:|:-------------------------------------------------------------------------------------------------------|
|  N1   | Доступность системы не ниже 99,95%.                                                                    |
|  N2   | Оповещение от момента фиксации события видеоаналитикой до уведомления — не более 5 секунд.             |
|  N3   | Реакция видеоаналитики в реальном времени (миллисекунды) на уровне edge.                               |
|  N4   | Расширяемость: добавление нового функционала и метрик без изменения существующего.                     |
|  N5   | Работа при отсутствии интернета; локальные уведомления; последующая синхронизация.                     |
|  N6   | Топология «центральный сервер — агенты»; задержка синхронизации до 10 минут (исключая проблемы связи). |
|  N7   | Поддержка камер разных производителей; ночная съёмка; минимизация слепых зон.                          |
|  N8   | Поддержка альтернативных каналов связи при нестабильном Wi‑Fi.                                         |
|  N9   | Безопасность: современные методы аутентификации (OIDC/SAML), авторизация по ролям.                     |

---

### **Детали**

- **Модель видеоаналитики**: предоставляется партнёрами; для MVP допустима путаница тени и животных; трекинг особей сложен из‑за схожести.
- **Инфраструктура ферм**: в Cloud‑first стабильность интернета критична; Edge — тонкий шлюз (ingest/форвардинг), без локальной аналитики.
- **Архитектурные принципы**: событийная модель; централизованный inference/корреляция в Core; Edge выполняет приём потоков/телеметрии и надёжную доставку в центр.
- **Оповещения**: централизованные push/SMS/веб‑уведомления из Core; при оффлайне — ограниченная функциональность, ретроспективная доставка.

---

### **Решение**

Контекст представлен на диаграмме C4 (Context). В центре — «Платформа мониторинга животных»: центральный сервер и агенты на фермах.
Взаимодействия включают камеры, систему аналитики, оборудование (кормушки/поилки), фильтрацию воды, провайдер уведомлений, внешний IdP и
потребителей API.

**Контекстная диаграмма (C4 + PlantUML)**

```plantuml
@startuml
' C4-PlantUML (Context)
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml

LAYOUT_WITH_LEGEND()

Person(op, "Оператор фермы", "Следит за состоянием, реагирует на оповещения")
Person(oncall, "Дежурный сотрудник", "Получает локальные уведомления при отсутствии интернета")

System_Boundary(core, "Платформа мониторинга животных (центральный сервер + агенты)") {
  System(system, "Платформа мониторинга животных",
    "Аналитика поведения, учёт поголовья, управление оборудованием, оповещения, метрики, API")
}

System_Ext(apps, "Мобильное/веб-приложение", "Клиенты, использующие публичный API")
System_Ext(cams, "Видеокамеры", "RTSP/ONVIF; дневная/ночная съёмка")
System_Ext(ml, "Партнёрская ML/видеоаналитика", "Готовая нейросеть для оценки состояния")
System_Ext(feeders, "Кормушки и поилки", "Контроллеры разных производителей")
System_Ext(water, "Система фильтрации воды", "Датчики/PLC, телеметрия, аварии")
System_Ext(notify, "Провайдер уведомлений", "SMS/Push/звонки; локальный шлюз на ферме")
System_Ext(extsys, "Внешние системы", "ERP/SCADA/BI — приём базовых/кастомных метрик")
System_Ext(idp, "Провайдер аутентификации (IdP)", "OIDC/SAML; SSO, роли и авторизация")

Rel(op, apps, "Использует")
Rel(oncall, notify, "Получает локальные оповещения", "SMS/Push/звонок")

Rel(apps, system, "Вызывает публичный API", "HTTPS/JSON; Web/Mobile")
Rel(system, apps, "Пуш-события/оповещения", "WebSocket/SSE")

Rel(system, cams, "Получает видеопотоки/метаданные", "RTSP/ONVIF; real-time")
Rel(system, ml, "Отправляет кадры/фичи → получает оценки", "gRPC/REST")
Rel(system, feeders, "Команды управления дозированием/поением", "API/fieldbus")
Rel(system, water, "Мониторинг состояния/алертов", "API/датчики")
Rel(system, notify, "Оповещения о нештатных ситуациях", "SMS/Push/звонок ≤ 5 с")
Rel(system, extsys, "Экспорт метрик", "HTTP/MQTT/CSV")
Rel(system, idp, "Аутентификация/авторизация (RBAC)", "OAuth2/OIDC")

UpdateElementStyle(system, $fontColor="white", $bgColor="#4A6EAA")
UpdateElementStyle(core, $borderColor="#4A6EAA")
UpdateElementStyle(op, $bgColor="#8BB174")
UpdateElementStyle(oncall, $bgColor="#8BB174")

note right of system
• Cloud‑first: централизованный inference, тонкие edge‑агенты
• Зависимость от интернета; при оффлайне — деградация сервисов
• SLA/RT ограничены каналом связи; проще централ. обновления
• Масштабирование центра; унификация моделей/версий
end note

@enduml
```

> *Примечание:* по запросу можно добавить контейнерную диаграмму (C4 Container) для раскрытия разбиения на подсистемы.

---

### **Альтернативы**

1. **Полностью облачная архитектура без локальных агентов**  
   — *Плюсы*: упрощённая эксплуатация, централизованные обновления.  
   — *Минусы*: не удовлетворяет оффлайн‑режиму и требованиям по миллисекундам; высокие риски задержек сети.

2. **Только локальные решения на фермах без центрального сервера**  
   — *Плюсы*: максимальная автономность, меньшая зависимость от интернета.  
   — *Минусы*: отсутствие единого центра агрегирования метрик и управления; сложность масштабирования и кросс‑фермерской аналитики.

3. **Единая унифицированная шина устройств вместо прямой интеграции**  
   — *Плюсы*: снижение связности, упрощение добавления новых устройств.  
   — *Минусы*: дополнительные точки отказа; накладные расходы на адаптацию; для MVP может быть избыточно.

**Недостатки, ограничения, риски**

- Нестабильная связь и покрытие камер → риск пропусков событий и данных; требуется буферизация и локальные алерты.
- Ошибки модели (тени, схожесть особей) → ложные срабатывания; нужна последующая калибровка, актив‑learning и правила пост‑обработки.
- Разнородность оборудования (камеры, контроллеры) → сложность интеграций и поддержки; предусмотреть абстракции драйверов/адаптеров.
- Требования по времени реакции (≤ 5 с уведомление, миллисекунды аналитики) → необходимость обработки на edge и минимизации цепочки
  оповещений.
- Безопасность и доступы: строгий RBAC, аудит, управление секретами; зависимость от внешнего IdP.
- Потеря данных при длительном оффлайне → стратегии повторной доставки и дедупликации при восстановлении связи.

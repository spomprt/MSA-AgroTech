# ADR: Архитектура платформы мониторинга и управления фермами (C2 + ограниченные контексты)

**Дата:** 2025-08-10
**Статус:** Proposed
**Решение уровня:** Архитектурное (микросервисы, интеграции, контейнеры)
**Нефункциональные цели (NFR):** Доступность 99.95%, оповещение ≤ 5 сек от детекции, RT реакция на Edge (мс), офлайн-режим, масштабируемость, расширяемость без ломки существующих контрактов.

---

## 1) Проблема
Нужно спроектировать платформу, которая:
- Анализирует видеопотоки от разнородных камер для детекции инцидентов (драки, задавливание поросят, болезнь/гибель, беспокойство) и пересчитывает поголовье.
- Управляет кормушками, поилками и системами фильтрации воды разных производителей.
- Работает при нестабильной связи: офлайн-на ферме, с последующей синхронизацией (≤10 минут).
- Предоставляет метрики (базовые и кастомные) и API для веб/мобильных клиентов и внешних систем (ERP/BI).
- Гарантирует SLA: 99.95% и оповещение ≤ 5 секунд с момента детекции на видео.

---

## 2) Контекст и ограниченные контексты (Bounded Contexts)
Платформа разделена на два домена развертывания и несколько ограниченных контекстов:

### Домены развертывания
- **Edge (Ферма):** низкая задержка, доступ к оборудованию/камерам, офлайн-режим, локальные уведомления.
- **Core (Центр):** агрегация событий и метрик, долгоживущие данные, интеграции, UI, оркестрация.

### Ограниченные контексты
1. **Video Analytics (Edge):** детекция событий, трекинг, пересчёт поголовья на видеопотоках. Источник «правды» по локальным инцидентам до синхронизации.
2. **Animal State (Core):** агрегация/обогащение инцидентов и состояний животных (здоровье/гибель/стресс), корреляция, подтверждение оператором.
3. **Feeding & Water Control (Edge/Core):** управление кормушками/поилками, контроль фильтрации воды; политика выдачи команд, фейл-сейф режимы.
4. **Device Registry (Core):** учёт устройств (камеры, контроллеры, агенты), сертификаты/ключи, совместимость, конфигурации.
5. **Inventory & Forecast (Core):** учёт запасов корма и прогноз расхода (на основе телеметрии и истории).
6. **Notifications (Edge/Core):** маршрутизация локальных и центральных уведомлений (SMS/Push/Email/звонок).
7. **Metrics & Export (Core):** сбор/экспорт метрик в Prometheus/OpenMetrics, построение витрин для ERP/BI.
8. **Sync (Edge↔Core):** устойчивый обмен конфигурациями/моделями/событиями, дедупликация, конфликт-резолюция, буферизация офлайн.
9. **AuthN/Z (Core):** OIDC/SAML, роли и политики доступа; на Edge — доверенная связь по mTLS/токенам устройств.

---

## 3) Решение (на высоком уровне)
- **Стиль интеграции:** событийно-ориентированная шина + запрашиваемые API. На Edge — локальная шина событий; с Core — надёжная синхронизация.
- **Согласованность:** Eventual consistency между Edge и Core (SLA ≤10 мин). Внутри Edge — строгие локальные инварианты для управления оборудованием.
- **Идентификаторы/время:** события с монотонными локальными ID и метками времени; дедупликация по (farmId, sourceId, localSeq, hash). Защита от дрейфа часов NTP + server-side reordering.
- **Хранение:** оперативные очереди/стримы для низкой задержки; долговременное хранилище инцидентов и телеметрии в Core; видео-фрагменты в объектном хранилище.
- **Наблюдаемость:** OpenTelemetry (traces/metrics/logs), кореляция событий Edge↔Core, SLO алерты.

---

## 4) Контейнеры (C2) — диаграмма
Ниже PlantUML (C4-PlantUML).

```plantuml
@startuml
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml
LAYOUT_WITH_LEGEND()
title C2 — Платформа мониторинга ферм (Core + Edge)

Boundary(core, "Core (Центр)") {
  Container(api, "API Gateway / BFF", "REST/GraphQL", "Единая точка входа для UI/интеграций; rate-limit, auth, схемы.")
  Container(ui, "Web UI", "SPA", "Рабочее место оператора/зоотехника.")
  Container(animal, "Animal State Service", "Service + DB", "Агрегация/обогащение инцидентов, статусы животных.")
  Container(inv, "Inventory & Forecast Service", "Service + DB", "Запасы корма и прогноз расхода.")
  Container(notif, "Notification Service", "Service", "Маршрутизация уведомлений (SMS/Push/Email).")
  Container(metrics, "Metrics & Exporter", "Service", "Prom/OpenMetrics, экспорт в ERP/BI.")
  Container(devreg, "Device Registry", "Service + DB", "Реестр устройств, сертификаты, конфиги.")
  Container(syncCore, "Sync Core", "Service", "Синхронизация с Edge (ingress/egress), дедупликация.")
  Container(obj, "Object Storage", "S3-совместимое", "Видео-фрагменты/снапшоты для доказательной базы.")
  Container(dbCore, "Core DB", "PostgreSQL/Timescale", "Инциденты, телеметрия, конфигурации.")
  Container(bus, "Message Broker", "RabbitMQ (+MQTT bridge)", "Шина событий/команд Core.")
  Container(otlp, "Observability Stack", "OTel Collector + Prometheus + Logs", "Трейсы/метрики/логи.")
  Container(auth, "AuthN/Z", "OIDC/SAML Provider", "Аутентификация и авторизация.")
  Container(bi, "ERP/BI Integrations", "Adapters", "Экспорт агрегатов/метрик/вебхуки.")
}

Boundary(edge, "Edge (Ферма)") {
  Container(edgehub, "Edge Hub", "Service", "Локальная шина, сбор телеметрии, буферизация офлайн, sync.")
  Container(va, "Video Analytics Service", "Service + GPU", "RT детекция, трекинг, пересчёт поголовья.")
  Container(ctrl, "Feeding & Water Control", "Service", "Команды к кормушкам/поилкам, фильтрации воды.")
  Container(camgw, "Camera Gateway", "Service", "RTSP/ONVIF, нормализация потоков, снапшоты.")
  Container(locnot, "Local Notifier", "Service", "Локальные SMS/звонок/мессенджер при отсутствии интернета.")
  Container(edgebus, "Edge Broker", "RabbitMQ (embedded) + MQTT", "Локальная шина для микросервисов Edge и устройств.")
  Container(edgedb, "Edge Store", "SQLite/Lightweight TSDB", "Кэш/очереди/офлайн журналы событий.")
}

Person(op, "Оператор/Зоотехник")
Person(oncall, "Дежурный на ферме")
Person(app, "Мобильное/веб-приложение")

Rel(op, ui, "Работа через браузер")
Rel(app, api, "Мобильный/веб-клиент", "HTTPS")
Rel(oncall, locnot, "Локальные оповещения", "GSM/SMS/звонок")

Rel(ui, api, "UI API", "HTTPS + OIDC")
Rel(api, animal, "CRUD/поиск инцидентов", "gRPC/REST")
Rel(api, inv, "Запасы/прогноз", "gRPC/REST")
Rel(api, devreg, "Реестр устройств", "gRPC/REST")
Rel(api, notif, "Отправка уведомлений", "REST")
Rel(api, metrics, "Метрики/дашборды", "Pull/Push")

Rel(syncCore, edgehub, "Двусторонняя синхронизация", "HTTPS/mTLS + AMQP over TLS")
Rel(edgehub, edgebus, "Публикация/подписка локально", "AMQP/MQTT")
Rel(va, edgebus, "События детекции", "AMQP")
Rel(ctrl, edgebus, "Команды/ACK", "AMQP/MQTT")
Rel(camgw, va, "Видеопотоки/кадры", "RTSP/UDPH + shared mem")
Rel(locnot, edgebus, "Подписка на критические события", "AMQP")

Rel(syncCore, bus, "Шлюз между доменами", "AMQP + retry/DLX")
Rel(bus, animal, "События инцидентов", "AMQP topics")
Rel(bus, notif, "События для уведомлений", "AMQP")
Rel(bus, inv, "Телеметрия/счетчики корма", "AMQP")
Rel(bus, metrics, "Метрики", "OpenMetrics/AMQP")
Rel(animal, dbCore, "Запись агрегатов", "SQL")
Rel(inv, dbCore, "Запись прогнозов", "SQL")
Rel(devreg, dbCore, "Конфигурации/устройства", "SQL")
Rel(va, obj, "Загрузка фрагментов/снапшотов", "S3 API via Sync")
Rel(edgehub, syncCore, "Буфер офлайн, дедупликация", "Store-&-forward")
Rel(metrics, bi, "Экспорт агрегатов/метрик", "Webhooks/CSV/S3")

Rel(auth, api, "OIDC/SAML")
Rel(otlp, core, "Сбор телеметрии", "OTLP")
Rel(otlp, edge, "Сбор телеметрии", "OTLP via Edge Hub")
@enduml
```

---

## 5) Интеграции и обоснование выбора технологий

### Сообщения/очереди: **RabbitMQ (+ MQTT bridge)**
**Преимущества:**
- Наличие MQTT-плагина/шлюза для взаимодействия с устройствами и контроллерами.
- Распространённость и зрелость, богатая экосистема клиентов.
- Нетребовательность к ресурсам, возможен встраиваемый вариант на Edge.
- Кластеризация и HA, DLX и retry-паттерны, маршрутизация (topics).
**Компромисс/ограничение:** при высоких сквозных объёмах телеметрии/видео-метаданных разумно добавить Kafka как стрим-платформу для Core (cold path), оставив RabbitMQ на горячем контуре событий/команд.

### Транспорт
- **Внешние API:** HTTPS REST/GraphQL через API Gateway/BFF — совместимость с мобильным/веб и внешними интеграциями.
- **Внутренние сервисы:** gRPC (низкая задержка, явные контракты, bidi streaming).  
**Компромисс:** два стека API повышают сложность документации и observability; окупается низкой задержкой и DX.

### Видеопотоки
- **RTSP/ONVIF** на входе (Camera Gateway), нормализация и выдача кадров в Video Analytics Service.  
**Компромисс:** ONVIF разнороден у вендоров; требуется тестовая матрица совместимости.

### Хранилища
- **Core DB:** PostgreSQL (+Timescale для временных рядов). Баланс OLTP (инциденты/каталоги) и TSDB (метрики/телеметрия).  
- **Edge Store:** SQLite/легкая TSDB для офлайн буфера и журналов.  
- **Object Storage:** S3-совместимое для видеофрагментов/снимков.  
**Компромисс:** Timescale упрощает SQL-аналитику, но требует внимательного тюнинга и может быть дороже в облаке; InfluxDB — альтернатива, но увеличивает зоопарк технологий.

### Наблюдаемость
- **OpenTelemetry + Prometheus + Логи**. Единый трейс-контекст сквозь Edge↔Core.  
**Компромисс:** дополнительная нагрузка и хранение метрик/логов; критично для SLO и отладки.

### Безопасность
- **Auth:** OIDC/SAML для пользователей; mTLS и короткоживущие токены для агентов и устройств.  
**Компромисс:** усложняет управление секретами; требуется Device Registry и ротация ключей.

### Синхронизация Edge↔Core
- **Store-and-forward** в Edge Hub, дедупликация, идемпотентные потребители в Core, стратегий конфликтов: last-write-wins + merge по доменным правилам.  
**Компромисс:** eventual consistency до 10 минут; операторский UI должен явно сигнализировать «данные не актуальны» при офлайне.

---

## 6) Компромиссы (сводно)
- **Eventual consistency** между доменами во имя устойчивости связи.
- **RabbitMQ сейчас / Kafka позже** при росте объёмов: простота и компактность на Edge важнее пикового throughput.
- **Двойной API стек (REST + gRPC)**: повышенная сложность ради производительности и удобства клиентов.
- **Timescale в Core / SQLite на Edge**: единый SQL везде, но разные классы производительности.
- **Edge-first аналитика**: RT требования выполняются локально; центральная корреляция позже (возможны расхождения до синхронизации).

---

## 7) Риски и меры снижения
- **Ошибки ML (тени, похожесть особей):** валидация оператором, активное обучение, периодические A/B модели, хранение фрагментов для ретро-анализа.
- **Нестабильная сеть:** альтернативные каналы (LTE/LoRa), локальные оповещения, backpressure и квоты буферов.
- **Разнородность камер/протоколов:** сертификация вендоров, адаптеры, fallback до снимков при деградации.
- **Потеря/дубликаты сообщений:** идемпотентность, дедупликация по ключам, DLX, ретраи с экспоненциальной паузой.
- **Clock drift:** NTP + server-side ordering; метки времени в обоих доменах.
- **Безопасность и утечка данных:** mTLS, rotation, least privilege, шифрование в покое, аудит.
- **SLA 5 секунд на оповещение:** приоритизация горячего контура (Edge→Core→Notification), ограничение тяжёлых операций, pre-warmed воркеры.

---

## 8) Альтернативы
- **Kafka везде:** +скейл стриминга, –тяжёлая на Edge, сложность эксплуатации.
- **Полный облачный inference:** –задержки/зависимость от сети, –невыполнимые RT требования.
- **Единая TSDB (InfluxDB) вместо Timescale:** +простота метрик, –хуже для транзакционных агрегатов/связей домена.

---

## 9) Решение (Decision)
Принять архитектуру Core+Edge с событийной шиной **RabbitMQ (+MQTT bridge)**, REST внешне и gRPC внутри; хранение **PostgreSQL/Timescale** в Core, **SQLite** на Edge, объектное хранилище **S3** для фрагментов; **OpenTelemetry** для наблюдаемости. Eventual consistency между доменами с офлайн буферизацией и дедупликацией.

## 10) Последствия (Consequences)
- Быстрое достижение SLA по задержкам и офлайн устойчивость.
- Прогнозируемая эксплуатация на ферме (лёгкие компоненты, локальные зависимости).
- Требуется дисциплина схем событий, контрактов gRPC/REST и управление версиями.

---

## 11) Критерии выбора решения
1. **Соответствие функциональным требованиям** — поддержка всех заявленных функций (детекция событий, управление оборудованием, интеграции, метрики, офлайн-режим).
2. **Соответствие нефункциональным требованиям** — SLA 99.95%, задержка оповещения ≤ 5 секунд, RT-реакция, масштабируемость.
3. **Устойчивость к сбоям связи** — работа Edge в офлайн-режиме, store-and-forward, альтернативные каналы связи.
4. **Масштабируемость и расширяемость** — модульная микросервисная архитектура, возможность добавления новых функций без изменения существующего.
5. **Простота эксплуатации на фермах** — минимальные аппаратные требования, известные технологии (RabbitMQ, PostgreSQL, SQLite).
6. **Гибкость интеграций** — API Gateway, поддержка REST/GraphQL/gRPC, брокер сообщений.
7. **Безопасность** — OIDC/SAML для пользователей, mTLS для агентов, контроль доступа, шифрование.
8. **TCO (Total Cost of Ownership)** — баланс затрат на оборудование, лицензии, поддержку и развитие.

---

## 12) Анализ по критериям

| Критерий | Оценка | Обоснование |
|----------|--------|-------------|
| Соответствие функциональным требованиям | ✅ | Решение покрывает все ключевые функции: видеодетекция, пересчёт, управление устройствами, интеграции, метрики. |
| Соответствие нефункциональным требованиям | ✅ | Архитектура Core+Edge с локальной обработкой обеспечивает SLA и задержки. |
| Устойчивость к сбоям связи | ✅ | Edge-агенты работают офлайн, есть альтернативные каналы, store-and-forward. |
| Масштабируемость и расширяемость | ✅ | Микросервисы, брокер, API, возможность модульных расширений без ломки существующих сервисов. |
| Простота эксплуатации на фермах | ✅ | RabbitMQ/SQLite не требуют сложной администрируемости, лёгкие агенты. |
| Гибкость интеграций | ✅ | API Gateway с REST/GraphQL/gRPC, брокер для событий, интеграции ERP/BI. |
| Безопасность | ✅ | OIDC/SAML, mTLS, ключи устройств, Device Registry. |
| TCO | ⚖ | Используются в основном open-source технологии, но требуется GPU на Edge и объектное хранилище в Core. |

---

## 13) Резюме (почему рекомендую)
Данное решение рекомендуется, так как оно:
- **Закрывает все бизнес-функции** и учитывает ограничения среды (нестабильная связь, офлайн-работа).
- **Гарантирует выполнение SLA** по доступности и задержкам за счёт архитектуры Core+Edge и приоритизации горячего контура.
- **Масштабируется и расширяется** без критических изменений архитектуры.
- **Использует зрелые, распространённые технологии**, что снижает риски внедрения и облегчает найм специалистов.
- **Обеспечивает гибкость интеграций** и готовность к подключению внешних систем и новых устройств.
- **Снижает риски** за счёт изоляции доменов, офлайн-буфера и идемпотентных интеграций.

Итог: Архитектура Core+Edge с RabbitMQ, REST/gRPC, PostgreSQL/SQLite и S3 — **оптимальный баланс между функциональностью, надёжностью, стоимостью и масштабируемостью** для проекта.

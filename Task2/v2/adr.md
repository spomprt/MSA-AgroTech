### **Название задачи:** 
Платформа мониторинга состояния животных на фермах (MVP)

### **Автор:**
spomprt

### **Дата:**
2025-08-10

---

### **Статус**

Альтернатива (Cloud‑first)

---

### **Проблема**
На животноводческих фермах требуется автоматический мониторинг здоровья и поведения животных, контроль инфраструктуры (кормление, поение, фильтрация воды), оперативное обнаружение нештатных ситуаций и оповещение персонала. Система должна стабильно работать при нестабильной связи, поддерживать оборудование разных производителей и предоставлять метрики/интеграции во внешние системы.

---

### **Функциональные требования**
| **№** | **Действующие лица или системы** | **Use Case** | **Описание** |
| :-: | :- | :- | :- |
| 1 | Система видеоаналитики ← Видеокамеры | Обнаружение беспокойства/драк | Поток с камер анализируется; при детекции тревоги формируется событие, запускается оповещение. |
| 2 | Система видеоаналитики ← Видеокамеры | Обнаружение задавливания поросят | Модель детектирует характерные позы/скопления; генерирует критическое событие. |
| 3 | Оператор → Платформа → Кормушки/поилки | Управление кормлением/поением | Оператор задаёт режимы; агенты отправляют команды на контроллеры разных производителей. |
| 4 | Система видеоаналитики | Оценка состояния животных | Классификация: болезнь, гибель, беспокойство и т.п.; формирование статусов и алертов. |
| 5 | Агенты → Система фильтрации воды | Мониторинг фильтрации | Сбор телеметрии, контроль аварий, триггер оповещений. |
| 6 | Платформа | Пересчёт поголовья | Подсчёт особей по видеопотокам/датчикам; сверка с учётными данными. |
| 7 | Платформа | Учёт запасов и прогноз расхода корма/воды | Интеграция с данными склада и фактическим потреблением; прогнозирование. |
| 8 | Платформа | Поддержка множества камер | Приём потоков от камер разных производителей; масштабирование под реальное время. |
| 9 | Центральный сервер ↔ Агенты | Синхронизация данных | Агенты работают автономно; синхронизация с центром допускает задержку до 10 минут. |
| 10 | Платформа → Внешние системы | Экспорт метрик | Предоставление базовых метрик и возможность добавления пользовательских. |
| 11 | Платформа → Дежурный сотрудник | Локальные уведомления без интернета | При потере связи агент уведомляет дежурного локально; после восстановления — синхронизация. |
| 12 | Пользователи → Платформа (IdP) | Роли, аутентификация и авторизация | Современные механизмы (SSO, RBAC). |
| 13 | Мобильное/веб-приложение → API | Доступ к данным и управлению | Публичный API для клиентов (web/mobile). |

---

### **Нефункциональные требования**
| **№** | **Требование** |
| :-: | :- |
| N1 | Доступность системы не ниже 99,95%. |
| N2 | Оповещение от момента фиксации события видеоаналитикой до уведомления — не более 5 секунд. |
| N3 | Реакция видеоаналитики в реальном времени (миллисекунды) на уровне edge. |
| N4 | Расширяемость: добавление нового функционала и метрик без изменения существующего. |
| N5 | Работа при отсутствии интернета; локальные уведомления; последующая синхронизация. |
| N6 | Топология «центральный сервер — агенты»; задержка синхронизации до 10 минут (исключая проблемы связи). |
| N7 | Поддержка камер разных производителей; ночная съёмка; минимизация слепых зон. |
| N8 | Поддержка альтернативных каналов связи при нестабильном Wi‑Fi. |
| N9 | Безопасность: современные методы аутентификации (OIDC/SAML), авторизация по ролям. |

---

### **Детали**
- **Модель видеоаналитики**: предоставляется партнёрами; для MVP допустима путаница тени и животных; трекинг особей сложен из‑за схожести.
- **Инфраструктура ферм**: для Cloud‑first устойчивый интернет критичен; Edge — тонкий шлюз ingest/форвардинга, без локальной аналитики.
- **Архитектурные принципы**: событийная модель; централизованный inference/корреляция в Core; Edge обеспечивает надёжную доставку и управление подключениями.
- **Оповещения**: централизованные push/SMS/веб‑уведомления; при оффлайне — функциональность ограничена, доставка ретроспективная.

---

### **Решение (контекст)**

```plantuml
@startuml
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml
LAYOUT_WITH_LEGEND()

Person(op, "Оператор фермы", "Следит за состоянием, реагирует на оповещения")
Person(oncall, "Дежурный сотрудник", "Получает локальные уведомления при отсутствии интернета")

System_Boundary(core, "Платформа мониторинга животных (центральный сервер + агенты)") {
  System(system, "Платформа мониторинга животных",
    "Аналитика, учёт поголовья, управление оборудованием, оповещения, метрики, API")
}

System_Ext(apps, "Мобильное/веб-приложение", "Клиенты API")
System_Ext(cams, "Видеокамеры", "RTSP/ONVIF; дневная/ночная съёмка")
System_Ext(ml, "Партнёрская ML/видеоаналитика", "Готовая нейросеть")
System_Ext(feeders, "Кормушки и поилки", "Контроллеры разных производителей")
System_Ext(water, "Система фильтрации воды", "Датчики/PLC, телеметрия, аварии")
System_Ext(notify, "Провайдер уведомлений", "SMS/Push/звонки; локальный шлюз на ферме")
System_Ext(extsys, "Внешние системы", "ERP/SCADA/BI — приём метрик")
System_Ext(idp, "Провайдер аутентификации (IdP)", "OIDC/SAML; SSO, роли и авторизация")

Rel(op, apps, "Использует")
Rel(oncall, notify, "Получает оповещения из центра", "SMS/Push/звонок")

Rel(apps, system, "Публичный API", "HTTPS/JSON; Web/Mobile")
Rel(system, apps, "Пуш-события/оповещения", "WebSocket/SSE")

Rel(system, cams, "Получает кадры/фичи через edge‑шлюз", "RTSP/ONVIF → gRPC")
Rel(system, ml, "Централизованный inference", "gRPC/REST")
Rel(system, feeders, "Команды управления дозированием/поением", "API/fieldbus")
Rel(system, water, "Мониторинг состояния/алертов", "API/датчики")
Rel(system, notify, "Оповещения о нештатных ситуациях", "SMS/Push/звонок ≤ 5 с")
Rel(system, extsys, "Экспорт метрик", "HTTP/MQTT/CSV")
Rel(system, idp, "Аутентификация/авторизация (RBAC)", "OAuth2/OIDC")

note right of system
• Cloud‑first: зависимость от интернета, централизованный inference
• При оффлайне — ограниченная функциональность, ретроспективная доставка
• SLA/RT ограничены сетью; проще централизованные обновления
end note
@enduml
```

---

### **Ограниченный контекст (для проектирования микросервисов, MVP)**
**В рамках:**
- Детекция событий по видео (драки, беспокойство, задавливание поросят), базовая оценка состояния.
- Управление устройствами (кормушки/поилки), мониторинг фильтрации воды.
- Пересчёт поголовья, агрегация и сверка результатов с edge.
- Оповещения (централизованные и локальные при оффлайне).
- Экспорт базовых метрик, добавление кастомных метрик.
- Топология «центральный сервер — агенты», синхронизация ≤ 10 минут, работа без интернета.

**Вне рамок (для последующих итераций):**
- Расширенная идентификация особей и продвинутый трекинг.
- Продвинутые алгоритмы оптимизации кормления, закрытый контур управления.
- Полноценная SCADA/IIoT‑платформа сверх обозначенного.

---

### **Диаграмма контейнеров (C2)**
См. отдельный файл `C2_Animal_Monitoring_Containers.puml` или блок ниже.

```plantuml
@startuml
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml
LAYOUT_WITH_LEGEND()

System_Boundary(central, "Центральная платформа") {
  Container(api, "API Gateway", "REST/GraphQL", "Единая точка входа для клиентов и интеграций")
  Container(authz, "AuthN/RBAC Proxy", "OIDC/SAML", "Прокси к IdP, управление ролями")
  Container(eventbus, "Event Bus", "RabbitMQ (AMQP)", "Очереди команд/событий; мост MQTT")
  Container(notify, "Notification Service", "gRPC/REST + SMPP", "Push/SMS/звонки; SLA ≤ 5 с")
  Container(device, "Device Control Service", "gRPC/REST", "Управление кормушками/поилками; адаптеры")
  Container(count, "Animal Counting Service", "gRPC", "Агрегация пересчёта с edge, сверка")
  Container(inv, "Inventory & Forecast Service", "gRPC", "Учёт запасов и прогноз расхода")
  Container(metrics, "Metrics/Telemetry Service", "OTLP/HTTP", "Сбор и экспорт метрик (ERP/BI)")
  Container(sync, "Sync Orchestrator", "gRPC + AMQP", "Синхронизация с агентами (≤10 мин)")
  ContainerDb(pg, "PostgreSQL", "Relational DB", "Транзакционные данные")
  ContainerDb(ts, "TimescaleDB/InfluxDB", "Time-series DB", "Телеметрия и метрики")
  ContainerDb(obj, "Object Storage", "S3/MinIO", "Кадры/клипы/артефакты аналитики")
  Container(redis, "Redis", "Cache", "Кэш/квоты/сессии/rate limits")
}

System_Boundary(edge, "Агент на ферме (Edge)") {
  Container(ingest, "Video Ingest", "RTSP/ONVIF → gRPC", "Приём потоков, декодирование, выбор кадров")
  Container(ml, "Video Analytics (Inference)", "gRPC", "Модель партнёров; миллисекундные реакции")
  Container(localproc, "Edge Event Processor", "AMQP (embedded)", "Правила корреляции; локальные алерты")
  Container(localnotify, "Local Notifier", "SMS/GSM/PA", "Оповещения при оффлайне")
  Container(localdevice, "Edge Device Adapter", "OPC-UA/Modbus/TCP/MQTT", "Команды к оборудованию")
  Container(localsync, "Edge Sync Agent", "gRPC + AMQP", "Буферизация и синхронизация с центром")
  ContainerDb(localdb, "Local DB", "PostgreSQL/SQLite", "Локальные состояния и очереди (outbox)")
}

' Внешние акторы/системы
Person(op, "Оператор/Приложение", "Web/Mobile")
System_Ext(idp, "IdP", "OIDC/SAML")
System_Ext(cams, "Видеокамеры", "RTSP/ONVIF")
System_Ext(feeders, "Кормушки/поилки", "Контроллеры")
System_Ext(water, "Фильтрация воды", "Датчики/PLC")
System_Ext(smsgw, "SMS/Push провайдер", "SMPP/FCM/APNS")
System_Ext(erp, "ERP/SCADA/BI", "Экспорт метрик")

' Связи клиентов
Rel(op, api, "REST/GraphQL + WebSocket/SSE")
Rel(api, authz, "OIDC/OAuth2", "AuthN/AuthZ")
Rel(authz, idp, "SSO", "OIDC/SAML")

' Центральные связи
Rel(api, notify, "Команды уведомлений")
Rel(api, device, "Команды управления")
Rel(api, count, "Запросы/отчёты пересчёта")
Rel(api, inv, "Запросы/отчёты запаса/прогнозов")
Rel(metrics, erp, "Экспорт метрик", "HTTP/MQTT/CSV")
Rel(notify, smsgw, "SMS/Push/звонки")
Rel(device, feeders, "Управление", "OPC-UA/Modbus/API")
Rel(device, water, "Мониторинг", "OPC-UA/Modbus/API")

Rel(eventbus, notify, "События/команды")
Rel(eventbus, device, "Команды")
Rel(eventbus, count, "События пересчёта")
Rel(eventbus, inv, "Телеметрия потребления")
Rel(eventbus, metrics, "Метрики")

Rel(sync, eventbus, "Оркестрация потоков")
Rel(sync, pg, "Persist")
Rel(sync, localsync, "Двунаправленная синхронизация", "gRPC + AMQP")
Rel(notify, redis, "Rate limits/locks")

Rel(count, pg, "CRUD")
Rel(inv, pg, "CRUD")
Rel(metrics, ts, "Write/Read")
Rel(count, obj, "Кадры/артефакты (при необходимости)")

' Edge связи
Rel(cams, ingest, "RTSP/ONVIF")
Rel(ingest, ml, "Кадры/фичи", "gRPC")
Rel(ml, localproc, "События детекции", "AMQP (embedded)")
Rel(localproc, localdevice, "Команды", "MQTT/OPC-UA/Modbus")
Rel(localproc, localnotify, "Локальные алерты", "SMS/GSM/PA")
Rel(localsync, localproc, "Буферизация событий", "Outbox/AMQP")
Rel(localsync, eventbus, "Публикация событий", "AMQP/MQTT (мост)")
Rel(localsync, sync, "Служебная синхронизация", "gRPC")
Rel(localdb, localsync, "Persist")
Rel(localdevice, feeders, "Команды напрямую при оффлайне", "Fieldbus/MQTT")
Rel(localdevice, water, "Статусы/алерты", "Fieldbus/MQTT")

@enduml
```

---

### **Интеграции и обоснование подходов/технологий**
**Коммуникации:**
- **Сервис‑сервис (синхронно):** gRPC (низкая задержка, строгие контракты, bidi‑stream при необходимости).
- **События/команды (асинхронно):** RabbitMQ (AMQP). Обменники: `events.video`, `events.alerts`, `commands.device`, `sync.*`. Гарантии: *at‑least‑once*, идемпотентные обработчики.
- **Устройства и телеметрия:** MQTT (через плагин/мост RabbitMQ) для edge‑шлюзов; QoS1 для команд, QoS0 для «шумной» телеметрии.
- **Видео:** RTSP/ONVIF; с центра уходят **только метаданные** и event‑снимки в Object Storage.
- **Публичный доступ:** REST/JSON + WebSocket/SSE через API Gateway. Внешние интеграции — HTTP/MQTT/CSV.
- **Аутентификация:** OIDC/SAML через IdP; внутри — mTLS, `AuthN/RBAC Proxy` выдает контекст ролей.

**Выбор очереди: RabbitMQ**
- **Преимущества:**
  - Мост в **MQTT** для взаимодействия с устройствами.
  - Зрелая, распространённая технология; клиенты почти для всех языков.
  - Нетребовательна к ресурсам; кластеризация/HA‑очереди.
  - Гибкая маршрутизация (topic/direct), TTL/DLX, отложенные очереди.
- **Ограничения/компромиссы:**
  - При очень больших потоках телеметрии и необходимости долговременного ретеншна/реплея — предпочтительнее **Kafka**.
  - Управление порядком сообщений глобально не гарантируется — выстраиваем per‑key (ферма/устройство) с идемпотентностью.

**Хранилища:**
- **PostgreSQL** — транзакции (животные, события, настройки, ACL). Риск: нагрузка на запись → реплики чтения/шардинг по фермам.
- **TimescaleDB/InfluxDB** — метрики/телеметрия. Риск: ретеншн‑политики и миграции; планирование хранения заранее.
- **Object Storage (S3/MinIO)** — кадры/клипы по событиям. Риск: задержка доступа и eventual consistency.
- **Redis** — кэш/квоты/сессии; хранить только воспроизводимое.
- **Edge Local DB (PostgreSQL/SQLite)** — локальные состояния, outbox для гарантированной доставки.

**Синхронизация центр ↔ edge:**
- Паттерны **Outbox + Retrying**, идемпотентные операции, порядок в пределах ключа фермы.
- Консистентность **eventual** (≤ 10 мин) для статусов/метрик; команды — подтверждения с fence‑ID, таймауты, retry.

**API для клиентов:**
- REST/JSON + WebSocket/SSE для стриминга алертов ≤ 5 с.
- Опционально GraphQL для агрегированных чтений; компромисс — кэширование сложнее.

---

### **Компромиссы и риски решения**
| Область | Выбор | Преимущества | Компромиссы/Риски | Митигирующие меры |
|---|---|---|---|---|
| Шина сообщений | RabbitMQ (AMQP) + MQTT мост | Простота, MQTT для устройств, кластеризация | Не для экстремально высокой пропускной, слабый ретеншн/реплей | Выделить Kafka для нагруженных потоков; DLX/партиционирование |
| Коммуникации сервис‑сервис | gRPC | Низкая задержка, строгие схемы | Нет нативной поддержки в браузере | Публичный REST/WS через API Gateway |
| Обработка видео | Edge Inference | Миллисекундная реакция, меньше трафика | Нужны GPU/NPUs, управление версиями | Канареечные обновления, реестр моделей, fallback правила |
| Консистентность | Eventual для телеметрии/статусов | Живучесть при оффлайне | Временные расхождения центр↔edge | SLA синхронизации ≤ 10 мин, версионирование, LWW-конфликты |
| Оповещения | Центр + Local Notifier | ≤ 5 с онлайн; оффлайн‑алерты | Дубли при retry | Идемпотентность alert‑ID, дедупликация, rate‑limits в Redis |
| Хранилища | Postgres + TSDB + S3 | Соответствие типам данных | Операционная сложность | Автоматизация, бэкапы, ретеншн‑политики |
| Устройства | OPC‑UA/Modbus/MQTT | Совместимость с парком устройств | Разнородность драйверов | Шлюзы, контрактные тесты, эмуляторы |
| Безопасность | OIDC/SAML + mTLS | Централизованный доступ | Наследие устройств без TLS | Сегментация сетей, VPN, только закрытые сегменты для fieldbus |

---

### **Критерии готовности (MVP)**
- Оповещение ≤ 5 с от детекции на edge (онлайн) и локальные SMS при оффлайне.
- Пересчёт поголовья сверяется и допускает ручную корректировку.
- Управление кормушками/поилками через адаптеры двух производителей.
- Синхронизация центр↔edge выдерживает разрыв связи и восстанавливается без дублей (идемпотентность).
- Экспорт базовых метрик во внешнюю систему подтверждён.

